// Copyright (c) 2000-2012 by Gary Johnson

onmessage=function(e)
{if(e.data==="start")
{doUnzipT("what")}
else
{postMessage("not done")}};function doUnzipT(where)
{postMessage("one");var opdir=gj53runGetPrefString("URL1");var opdirObj=getLocalFileObj(opdir);if(!opdirObj.exists())
{gj53runShowAlert(null,"-- Error --","Your directory "+opdir+" does not exist - Please Reinstall \n");window.close();return;}
var zipdir=getZipDirLocalFileObj();szipFiles=new Array("gj53run1.zip","gj53run2.zip","gj53run3.zip","gj53run4.zip");var unzip="unzip ";postMessage("two");var os=gjwhichOS();for(var i=0;i<szipFiles.length;i++)
{showProgress('p'+i);var scriptfile=zipdir.clone();if(os=="w")
{scriptfile.append("gjtemp.cmd");}
else if((os=='m')||(os=='x'))
{scriptfile.append("gjtemp.sh");}
var fos=Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);fos.init(scriptfile,0x04|0x08|0x20,0700,0);var line;if(os=="w")
{line="cd /d ";line+="\""+zipdir.path+"\"\n";line+=unzip+"-uo "+szipFiles[i]+" -d\""+opdir+"\""+"\n";}
else if((os=='m')||(os=='x'))
{line='#!/bin/sh'+"\n";line+="cd -P ";line+="\""+zipdir.path+"\"\n";line+=unzip+"-uo "+szipFiles[i]+" -d\""+opdir+"\""+"\n";}
else
{gj53runShowAlert(null,"-- Error --","\nPlatform "+os+" Not supported");}
line+="\n";fos.write(line,line.length);fos.close();Components.utils.reportError("Debug Msg doUnzip command "+line);var process=Components.classes["@mozilla.org/process/util;1"].createInstance(Components.interfaces.nsIProcess);if(os=='w')
{process.init(scriptfile);}
else if((os=='m')||(os=='x'))
{var sh=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);sh.initWithPath("/bin/sh");process.init(sh);}
else
{gj53runShowAlert(null,"-- Error --","\nPlatform "+os+" Not supported");}
var args=[scriptfile.path];try
{process.run(false,args,args.length);}
catch(err)
{gjonxulerror("error","Failure in doUnzip process.run "+err);}}
try
{for(var i=0;i<szipFiles.length;i++)
{var zipfile=getZipFileLocalFileObjT(szipFiles[i]);}
scriptfile.remove(false);}
catch(err)
{gjonxulerror("error","Failure in doUnzip remove zip file "+err);}
var myurl2="chrome://gj53run/content/MyStartup.xul";if(where=='j')
{mySBopenURLIn(myurl2,"current");}
else
{window.close();gj53runopenURLIn(myurl2);}}
function getZipFileLocalFileObjT(infile)
{try
{var sstrpart1=getFFpath('ProfD')
var sstrpart2=makePlatformPath('\\extensions\\{2ea91495-764f-44ab-9639-dcb810fa1b43}\\temp\\');var zipfile=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);var os=gjwhichOS()
if(os=='w')
{zipfile.initWithPath(sstrpart1+sstrpart2+infile);}
else if((os=='m')||(os=='x'))
{Components.utils.reportError("Debug Msg getZipFileLocalFileObj"+sstrpart2);zipfile.initWithPath(sstrpart1+sstrpart2+infile);}
return zipfile}
catch(err)
{gjonxulerror("error  getZipFileLocalFileObj ",err);return false;}}
function showProgress(what)
{try
{postMessage(what);}
catch(err)
{}}